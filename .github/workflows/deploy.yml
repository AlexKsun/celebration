name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªæ¨©é™
permissions:
  contents: read
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Replace environment variables
      run: |
        echo "ç’°å¢ƒå¤‰æ•°ã‚’ç½®æ›ä¸­..."

        # HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ç’°å¢ƒå¤‰æ•°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
        sed -i "s|{{GAS_URL}}|${{ secrets.GAS_URL }}|g" index.html
        sed -i "s|{{AUTH_PASSWORD}}|${{ secrets.AUTH_PASSWORD }}|g" index.html

        # window.ENV ã« AUTH_PASSWORD ã‚’è¿½åŠ 
        sed -i "s|GAS_URL: '{{GAS_URL}}'|GAS_URL: '{{GAS_URL}}', AUTH_PASSWORD: '{{AUTH_PASSWORD}}'|g" index.html
        sed -i "s|GAS_URL: '${{ secrets.GAS_URL }}'|GAS_URL: '${{ secrets.GAS_URL }}', AUTH_PASSWORD: '${{ secrets.AUTH_PASSWORD }}'|g" index.html

        # ç½®æ›çµæœã‚’ç¢ºèªï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ä¸€éƒ¨ã‚’ãƒã‚¹ã‚¯ï¼‰
        echo "GAS_URLç½®æ›å®Œäº†: $(echo '${{ secrets.GAS_URL }}' | sed 's/\(.\{10\}\).*/\1.../')"
        echo "AUTH_PASSWORDç½®æ›å®Œäº†: $(echo '${{ secrets.AUTH_PASSWORD }}' | sed 's/./*/g')"
      env:
        GAS_URL: ${{ secrets.GAS_URL }}
        AUTH_PASSWORD: ${{ secrets.AUTH_PASSWORD }}

    - name: Remove development files for production
      run: |
        echo "æœ¬ç•ªç’°å¢ƒç”¨ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."

        # é–‹ç™ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        rm -f .env .env.example

        # ç®¡ç†è€…ãƒ„ãƒ¼ãƒ«ã‚’å‰Šé™¤
        sed -i '/<script src="scripts\/admin.js"><\/script>/d' index.html

        # .env ãƒ­ãƒ¼ãƒ€ãƒ¼ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’ç„¡åŠ¹åŒ–ï¼ˆæœ¬ç•ªã§ã¯ç’°å¢ƒå¤‰æ•°ã®ã¿ä½¿ç”¨ï¼‰
        sed -i 's/await this.loadFromEnvFile();/\/\/ await this.loadFromEnvFile(); \/\/ Disabled in production/g' scripts/env-loader.js

    - name: Validate configuration
      run: |
        echo "è¨­å®šã‚’æ¤œè¨¼ä¸­..."

        # å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -z "${{ secrets.GAS_URL }}" ]; then
          echo "âŒ ã‚¨ãƒ©ãƒ¼: GAS_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "GitHub Pages ã® Environment variables ã§ GAS_URL ã‚’è¨­å®šã—ã¦ãã ã•ã„"
          exit 1
        fi

        if [ -z "${{ secrets.AUTH_PASSWORD }}" ]; then
          echo "âŒ ã‚¨ãƒ©ãƒ¼: AUTH_PASSWORD ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "GitHub Pages ã® Environment variables ã§ AUTH_PASSWORD ã‚’è¨­å®šã—ã¦ãã ã•ã„"
          exit 1
        fi

        # GAS URLã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
        if [[ ! "${{ secrets.GAS_URL }}" =~ ^https://script\.google\.com/macros/s/.*/exec$ ]]; then
          echo "âŒ ã‚¨ãƒ©ãƒ¼: GAS_URL ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"
          echo "æ­£ã—ã„å½¢å¼: https://script.google.com/macros/s/SCRIPT_ID/exec"
          exit 1
        fi

        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€ä½6æ–‡å­—ï¼‰
        if [ ${#AUTH_PASSWORD} -lt 6 ]; then
          echo "âš ï¸ è­¦å‘Š: AUTH_PASSWORD ã¯6æ–‡å­—ä»¥ä¸Šã‚’æ¨å¥¨ã—ã¾ã™"
        fi

        echo "âœ… è¨­å®šæ¤œè¨¼å®Œäº†"
      env:
        AUTH_PASSWORD: ${{ secrets.AUTH_PASSWORD }}

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Deployment summary
      run: |
        echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†!"
        echo "ã‚µã‚¤ãƒˆURL: ${{ steps.deployment.outputs.page_url }}"
        echo "Environment: github-pages"